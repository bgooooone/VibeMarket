# 校园购物商城部署说明

## 1. 部署环境准备

### 1.1 硬件要求
- **CPU**：至少4核
- **内存**：至少8GB RAM
- **硬盘**：至少100GB可用空间
- **网络**：稳定的网络连接

### 1.2 软件要求
- **操作系统**：Linux (推荐Ubuntu 20.04 LTS) 或 Windows Server
- **Docker**：20.10.0 及以上版本
- **Docker Compose**：1.29.0 及以上版本
- **Git**：用于代码拉取

## 2. 系统架构概述

校园购物商城采用前后端分离的架构设计，主要包括以下组件：

1. **前端应用**：Vue.js 3.x + Element Plus，部署在Nginx容器中
2. **后端应用**：Spring Boot 2.x + MyBatis，部署在Java容器中
3. **数据库**：MySQL 8.x，部署在专用数据库容器中
4. **反向代理**：Nginx，负责请求路由和静态资源服务

## 3. 部署前准备

### 3.1 代码获取

```bash
# 克隆代码仓库
git clone [代码仓库地址] cd VibeMarket
```

### 3.2 环境变量配置

创建环境变量配置文件 `.env`，根据实际情况设置以下参数：

```dotenv
# 数据库配置
DB_HOST=mysql
DB_PORT=3306
DB_NAME=shopping_mall
DB_USERNAME=root
DB_PASSWORD=your_database_password

# 后端服务配置
SPRING_PROFILES_ACTIVE=prod
JWT_SECRET=your_jwt_secret_key
SERVER_PORT=8080

# 文件上传配置
UPLOAD_PATH=/app/upload
MAX_FILE_SIZE=10MB

# 前端配置
VUE_APP_API_BASE_URL=http://your_domain.com/api
```

## 4. 数据库部署

### 4.1 初始化数据库

1. 首先启动MySQL容器：

```bash
docker run -d \
  --name mysql \
  -e MYSQL_ROOT_PASSWORD=your_database_password \
  -e MYSQL_DATABASE=shopping_mall \
  -v mysql-data:/var/lib/mysql \
  -p 3306:3306 \
  mysql:8.0
```

2. 导入数据库脚本：

```bash
# 将数据库脚本复制到容器内
docker cp sql/init.sql mysql:/tmp/

# 执行初始化脚本
docker exec -it mysql mysql -u root -p shopping_mall < /tmp/init.sql
```

## 5. 后端服务部署

### 5.1 构建后端应用

```bash
cd backend
# 使用Maven构建项目
./mvnw clean package -DskipTests

# 构建Docker镜像
docker build -t shopping-backend .
```

### 5.2 运行后端容器

```bash
docker run -d \
  --name shopping-backend \
  --link mysql:mysql \
  -p 8080:8080 \
  -v ${PWD}/upload:/app/upload \
  --env-file .env \
  shopping-backend
```

## 6. 前端应用部署

### 6.1 构建前端应用

```bash
cd frontend
# 安装依赖
npm install

# 构建生产版本
npm run build

# 构建Docker镜像
docker build -t shopping-frontend .
```

### 6.2 配置Nginx

创建Nginx配置文件 `nginx.conf`：

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # 前端静态资源配置
    server {
        listen 80;
        server_name localhost;

        # 静态资源服务
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # API代理配置
        location /api {
            proxy_pass http://shopping-backend:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 文件上传目录
        location /upload {
            alias /app/upload;
            autoindex off;
        }
    }
}
```

### 6.3 运行前端容器

```bash
docker run -d \
  --name shopping-frontend \
  --link shopping-backend:shopping-backend \
  -p 80:80 \
  -v ${PWD}/nginx.conf:/etc/nginx/nginx.conf \
  -v shopping-upload:/app/upload \
  shopping-frontend
```

## 7. 使用Docker Compose部署（推荐）

为了简化部署流程，推荐使用Docker Compose进行容器编排。

### 7.1 创建docker-compose.yml文件

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
    volumes:
      - mysql-data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    build: ./backend
    container_name: shopping-backend
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/${DB_NAME}?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      SERVER_PORT: 8080
      UPLOAD_PATH: /app/upload
    volumes:
      - shopping-upload:/app/upload
    ports:
      - "8080:8080"

  frontend:
    build: ./frontend
    container_name: shopping-frontend
    restart: always
    depends_on:
      - backend
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - shopping-upload:/app/upload
    ports:
      - "80:80"

volumes:
  mysql-data:
  shopping-upload:
```

### 7.2 启动所有服务

```bash
docker-compose up -d
```

### 7.3 查看服务状态

```bash
docker-compose ps
```

## 8. 部署验证

### 8.1 访问系统

打开浏览器，访问以下地址：
- 前台系统：http://服务器IP或域名
- 后台管理系统：http://服务器IP或域名/admin

### 8.2 检查服务日志

```bash
# 查看后端日志
docker logs shopping-backend

# 查看前端/nginx日志
docker logs shopping-frontend

# 查看数据库日志
docker logs mysql
```

## 9. 常见问题排查

### 9.1 数据库连接失败
- 检查数据库服务是否正常运行
- 验证数据库用户名和密码是否正确
- 确认网络连通性

### 9.2 服务启动失败
- 检查端口是否被占用
- 查看容器日志获取详细错误信息
- 验证环境变量配置是否正确

### 9.3 前端页面访问异常
- 检查Nginx配置是否正确
- 验证API代理设置
- 确认前端构建文件是否完整

## 10. 维护与更新

### 10.1 数据备份

定期备份数据库：

```bash
docker exec mysql mysqldump -u root -p ${DB_NAME} > backup_$(date +%Y%m%d).sql
```

### 10.2 系统更新

1. 更新代码：
```bash
git pull
```

2. 重建并重启服务：
```bash
docker-compose down
docker-compose up -d --build
```

## 11. 安全加固建议

1. **修改默认密码**：使用强密码并定期更换
2. **启用HTTPS**：配置SSL证书
3. **防火墙设置**：限制必要的端口访问
4. **定期更新**：及时更新系统和依赖包
5. **日志监控**：定期检查系统日志，及时发现异常

## 12. 附录

### 12.1 环境变量说明

| 环境变量 | 说明 | 默认值 |
| :--- | :--- | :--- |
| DB_HOST | 数据库主机地址 | mysql |
| DB_PORT | 数据库端口 | 3306 |
| DB_NAME | 数据库名称 | shopping_mall |
| DB_USERNAME | 数据库用户名 | root |
| DB_PASSWORD | 数据库密码 | - |
| JWT_SECRET | JWT密钥 | - |
| SERVER_PORT | 后端服务端口 | 8080 |
| UPLOAD_PATH | 文件上传路径 | /app/upload |
| MAX_FILE_SIZE | 最大文件大小 | 10MB |

### 12.2 默认账号信息

- **管理员账号**：admin
- **管理员密码**：admin123
- 首次登录后请立即修改默认密码！

---

**注意**：本部署说明基于文档中的技术栈和架构设计编写，实际部署时请根据具体环境进行调整。如有任何问题，请参考相关技术文档或联系技术支持。