# 校园购物商城数据库设计文档

## 1. 文档概述

### 1.1 文档目的
本文档详细描述校园购物商城系统的数据库设计，包括表结构设计、字段说明、索引设计、关系设计等，为系统开发提供数据库层面的指导。

### 1.2 术语定义
- **PK**：主键（Primary Key）
- **FK**：外键（Foreign Key）
- **NN**：非空（Not Null）
- **UQ**：唯一（Unique）
- **AI**：自增（Auto Increment）

## 2. 数据库设计原则

1. **规范性原则**：遵循数据库规范化设计，减少数据冗余
2. **完整性原则**：确保数据的准确性和一致性
3. **安全性原则**：保护敏感数据，防止未授权访问
4. **可扩展性原则**：设计灵活，易于扩展
5. **性能优化原则**：合理设计索引，优化查询性能

## 3. 数据库表结构设计

### 3.1 用户表（user）

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PK, AI, NN` | 用户ID |
| `username` | `VARCHAR(50)` | `UQ, NN` | 用户名 |
| `password` | `VARCHAR(255)` | `NN` | 密码（加密存储） |
| `phone` | `VARCHAR(20)` | `UQ` | 手机号 |
| `email` | `VARCHAR(100)` | `UQ` | 邮箱 |
| `avatar` | `VARCHAR(255)` | | 头像URL |
| `nickname` | `VARCHAR(50)` | | 昵称 |
| `gender` | `TINYINT` | `DEFAULT 0` | 性别（0:未知, 1:男, 2:女） |
| `birthday` | `DATE` | | 生日 |
| `status` | `TINYINT` | `DEFAULT 1` | 状态（0:禁用, 1:启用） |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |
| `last_login_time` | `DATETIME` | | 最后登录时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`username`, `phone`, `email`
- 普通索引：`create_time`

### 3.2 商品分类表（category）

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PK, AI, NN` | 分类ID |
| `name` | `VARCHAR(50)` | `NN` | 分类名称 |
| `parent_id` | `BIGINT` | `DEFAULT 0` | 父分类ID（0表示顶级分类） |
| `level` | `TINYINT` | `DEFAULT 1` | 分类级别（1:一级, 2:二级, 3:三级） |
| `sort` | `INT` | `DEFAULT 0` | 排序序号 |
| `icon` | `VARCHAR(255)` | | 分类图标URL |
| `status` | `TINYINT` | `DEFAULT 1` | 状态（0:禁用, 1:启用） |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 普通索引：`parent_id`, `sort`, `status`

### 3.3 商品表（product）

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PK, AI, NN` | 商品ID |
| `name` | `VARCHAR(100)` | `NN` | 商品名称 |
| `category_id` | `BIGINT` | `FK, NN` | 分类ID |
| `price` | `DECIMAL(10,2)` | `NN` | 价格 |
| `original_price` | `DECIMAL(10,2)` | | 原价 |
| `stock` | `INT` | `NN` | 库存 |
| `sales` | `INT` | `DEFAULT 0` | 销量 |
| `description` | `LONGTEXT` | | 商品描述 |
| `detail` | `LONGTEXT` | | 商品详情 |
| `main_image` | `VARCHAR(255)` | | 主图URL |
| `images` | `TEXT` | | 轮播图URL（JSON数组格式） |
| `status` | `TINYINT` | `DEFAULT 1` | 状态（0:下架, 1:上架） |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 外键索引：`category_id`
- 普通索引：`name`, `price`, `sales`, `status`, `create_time`

### 3.4 购物车表（cart）

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PK, AI, NN` | 购物车ID |
| `user_id` | `BIGINT` | `FK, NN` | 用户ID |
| `product_id` | `BIGINT` | `FK, NN` | 商品ID |
| `quantity` | `INT` | `NN` | 数量 |
| `selected` | `TINYINT` | `DEFAULT 1` | 是否选中（0:未选中, 1:选中） |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 外键索引：`user_id`, `product_id`
- 复合索引：`(user_id, product_id)`（唯一约束）

### 3.5 订单表（orders）

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PK, AI, NN` | 订单ID |
| `order_no` | `VARCHAR(50)` | `UQ, NN` | 订单号 |
| `user_id` | `BIGINT` | `FK, NN` | 用户ID |
| `total_amount` | `DECIMAL(10,2)` | `NN` | 订单总金额 |
| `actual_pay` | `DECIMAL(10,2)` | `NN` | 实际支付金额 |
| `status` | `TINYINT` | `DEFAULT 0` | 订单状态（0:待支付, 1:待发货, 2:待收货, 3:待评价, 4:已完成, 5:已取消, 6:已退款） |
| `payment_type` | `TINYINT` | | 支付方式（1:微信, 2:支付宝） |
| `payment_no` | `VARCHAR(100)` | | 支付流水号 |
| `consignee` | `VARCHAR(50)` | `NN` | 收货人姓名 |
| `phone` | `VARCHAR(20)` | `NN` | 收货人电话 |
| `province` | `VARCHAR(50)` | `NN` | 省份 |
| `city` | `VARCHAR(50)` | `NN` | 城市 |
| `district` | `VARCHAR(50)` | `NN` | 区县 |
| `detail_address` | `VARCHAR(255)` | `NN` | 详细地址 |
| `remark` | `VARCHAR(255)` | | 订单备注 |
| `payment_time` | `DATETIME` | | 支付时间 |
| `delivery_time` | `DATETIME` | | 发货时间 |
| `receive_time` | `DATETIME` | | 收货时间 |
| `cancel_time` | `DATETIME` | | 取消时间 |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`order_no`
- 外键索引：`user_id`
- 普通索引：`status`, `create_time`, `payment_time`

### 3.6 订单项表（order_item）

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PK, AI, NN` | 订单项ID |
| `order_id` | `BIGINT` | `FK, NN` | 订单ID |
| `product_id` | `BIGINT` | `FK, NN` | 商品ID |
| `product_name` | `VARCHAR(100)` | `NN` | 商品名称 |
| `product_image` | `VARCHAR(255)` | | 商品图片 |
| `unit_price` | `DECIMAL(10,2)` | `NN` | 商品单价 |
| `quantity` | `INT` | `NN` | 购买数量 |
| `total_price` | `DECIMAL(10,2)` | `NN` | 小计金额 |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 外键索引：`order_id`, `product_id`
- 普通索引：`order_id`

### 3.7 管理员表（admin）

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PK, AI, NN` | 管理员ID |
| `username` | `VARCHAR(50)` | `UQ, NN` | 用户名 |
| `password` | `VARCHAR(255)` | `NN` | 密码（加密存储） |
| `name` | `VARCHAR(50)` | | 姓名 |
| `phone` | `VARCHAR(20)` | | 电话 |
| `email` | `VARCHAR(100)` | | 邮箱 |
| `role_id` | `BIGINT` | | 角色ID |
| `status` | `TINYINT` | `DEFAULT 1` | 状态（0:禁用, 1:启用） |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |
| `last_login_time` | `DATETIME` | | 最后登录时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`username`
- 普通索引：`status`

### 3.8 商品评价表（review）

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PK, AI, NN` | 评价ID |
| `user_id` | `BIGINT` | `FK, NN` | 用户ID |
| `product_id` | `BIGINT` | `FK, NN` | 商品ID |
| `order_item_id` | `BIGINT` | `FK, NN` | 订单项ID |
| `rating` | `TINYINT` | `NN` | 评分（1-5星） |
| `content` | `TEXT` | | 评价内容 |
| `images` | `TEXT` | | 评价图片（JSON数组格式） |
| `likes` | `INT` | `DEFAULT 0` | 点赞数 |
| `status` | `TINYINT` | `DEFAULT 1` | 状态（0:待审核, 1:已审核, 2:已禁用） |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 外键索引：`user_id`, `product_id`, `order_item_id`
- 普通索引：`rating`, `status`, `create_time`

### 3.9 收货地址表（address）

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | `PK, AI, NN` | 地址ID |
| `user_id` | `BIGINT` | `FK, NN` | 用户ID |
| `consignee` | `VARCHAR(50)` | `NN` | 收货人姓名 |
| `phone` | `VARCHAR(20)` | `NN` | 收货人电话 |
| `province` | `VARCHAR(50)` | `NN` | 省份 |
| `city` | `VARCHAR(50)` | `NN` | 城市 |
| `district` | `VARCHAR(50)` | `NN` | 区县 |
| `detail_address` | `VARCHAR(255)` | `NN` | 详细地址 |
| `is_default` | `TINYINT` | `DEFAULT 0` | 是否默认地址（0:否, 1:是） |
| `create_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `update_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 外键索引：`user_id`
- 复合索引：`(user_id, is_default)`

## 4. 数据库关系设计

### 4.1 实体关系图

```
+---------------+        +----------------+        +----------------+
|    user       |        |    address     |        |      cart      |
+---------------+        +----------------+        +----------------+
| id (PK)       |1------N| id (PK)        |N------1| id (PK)        |
| username      |        | user_id (FK)   |        | user_id (FK)   |
| password      |        | consignee      |        | product_id (FK)| 1
| phone         |        | phone          |        | quantity       | |
| email         |        | province       |        | selected       | |
| avatar        |        | city           |        | ...            | |
| ...           |        | district       |        +----------------+ |
+---------------+        | detail_address |                        |
                         | is_default     |                        |
                         +----------------+                        |
                                   1                               |
                                   |                               |
                                   |                               |
                                   |                               |
+---------------+        +----------------+        +----------------+       +---------------+
|    admin      |        |     orders     |        |   order_item   |       |    product     |
+---------------+        +----------------+        +----------------+       +---------------+
| id (PK)       |        | id (PK)        |1-----N | id (PK)        |       | id (PK)        |
| username      |        | order_no       |        | order_id (FK)  |       | name           |
| password      |        | user_id (FK)   |        | product_id (FK)|<------| category_id (FK)| 1
| name          |        | total_amount   |        | product_name   |       | price          | |
| ...           |        | actual_pay     |        | unit_price     |       | stock          | |
+---------------+        | status         |        | quantity       |       | description    | |
                         | consignee      |        | ...            |       | ...            | |
                         | ...            |        +----------------+       +---------------+
                         +----------------+              |                        |
                                   |                     |                        |
                                   |                     |                        |
                                   |                     |                        |
                         +----------------+              |                        |
                         |     review     |              |                        |
                         +----------------+              |                        |
                         | id (PK)        |              |                        |
                         | user_id (FK)   |              |                        |
                         | product_id (FK)|<-------------+                        |
                         | order_item_id (FK)           |                        |
                         | rating         |              |                        |
                         | content        |              |                        |
                         | ...            |              |                        |
                         +----------------+              |                        |
                                                         |                        |
                                                         |                        |
                                                         |                        |
                         +----------------+              |                        |
                         |    category    |              |                        |
                         +----------------+              |                        |
                         | id (PK)        |              |                        |
                         | name           |              |                        |
                         | parent_id      |              |                        |
                         | level          |              |                        |
                         | ...            |<-------------+                        |
                         +----------------+                                      |
                                                                                  |
                                                                                  |
                                                                                  |
                                                                                  |
                         +----------------+                                      |
                         |    review      |                                      |
                         +----------------+                                      |
                         | id (PK)        |                                      |
                         | user_id (FK)   |                                      |
                         | product_id (FK)|<-------------------------------------+
                         | order_item_id (FK)                                   
                         | rating         |
                         | content        |
                         | ...            |
                         +----------------+
```

### 4.2 关系说明

1. **用户与地址**：一对多关系（1:N）
   - 一个用户可以有多个收货地址
   - 每个地址属于一个用户

2. **用户与购物车**：一对多关系（1:N）
   - 一个用户可以有多个购物车商品
   - 每个购物车商品属于一个用户

3. **用户与订单**：一对多关系（1:N）
   - 一个用户可以有多个订单
   - 每个订单属于一个用户

4. **订单与订单项**：一对多关系（1:N）
   - 一个订单可以包含多个订单项
   - 每个订单项属于一个订单

5. **订单项与商品**：多对一关系（N:1）
   - 多个订单项可以对应同一个商品
   - 每个订单项对应一个商品

6. **商品与分类**：多对一关系（N:1）
   - 多个商品可以属于同一个分类
   - 每个商品属于一个分类

7. **用户与评价**：一对多关系（1:N）
   - 一个用户可以发布多个评价
   - 每个评价属于一个用户

8. **商品与评价**：一对多关系（1:N）
   - 一个商品可以有多个评价
   - 每个评价对应一个商品

9. **订单项与评价**：一对一关系（1:1）
   - 一个订单项可以有一个评价
   - 一个评价对应一个订单项

## 5. 数据库优化策略

### 5.1 索引优化

1. **主键索引**：为所有表的主键字段创建索引
2. **外键索引**：为所有外键字段创建索引
3. **查询条件索引**：为经常作为查询条件的字段创建索引
4. **排序字段索引**：为经常用于排序的字段创建索引
5. **复合索引**：对于多字段查询，创建复合索引（注意最左前缀原则）

### 5.2 查询优化

1. **避免全表扫描**：合理使用索引，避免在索引字段上使用函数
2. **优化JOIN操作**：小表驱动大表，确保JOIN条件上有索引
3. **使用LIMIT分页**：避免一次性返回大量数据
4. **避免SELECT ***：只查询需要的字段
5. **使用EXPLAIN分析**：定期使用EXPLAIN分析查询执行计划

### 5.3 事务优化

1. **保持事务简短**：减少事务持有锁的时间
2. **避免长事务**：将大事务拆分为小事务
3. **合理设置隔离级别**：根据业务需求选择合适的隔离级别
4. **使用索引优化锁**：减少锁的范围

### 5.4 存储优化

1. **数据类型选择**：选择合适的数据类型，避免存储空间浪费
2. **分表分库**：对于大数据量，考虑水平分表或垂直分表
3. **定期清理数据**：清理历史数据和无效数据
4. **使用缓存**：热点数据使用Redis缓存

## 6. 数据库安全措施

### 6.1 访问控制

1. **最小权限原则**：数据库用户只授予必要的权限
2. **角色分离**：开发、测试、生产环境使用不同的数据库账号
3. **定期修改密码**：定期更换数据库账号密码

### 6.2 数据加密

1. **密码加密**：用户密码使用BCrypt等算法加密存储
2. **敏感数据加密**：对敏感数据进行加密存储
3. **传输加密**：使用SSL/TLS加密数据传输

### 6.3 SQL注入防护

1. **使用参数化查询**：避免直接拼接SQL语句
2. **输入验证**：对用户输入进行严格验证和过滤
3. **使用ORM框架**：使用MyBatis等ORM框架，减少SQL注入风险

### 6.4 日志审计

1. **开启慢查询日志**：监控慢查询，优化性能
2. **记录操作日志**：记录关键数据操作，便于审计
3. **备份日志文件**：定期备份数据库日志文件

## 7. 数据库备份与恢复策略

### 7.1 备份策略

1. **全量备份**：每天进行一次全量备份
2. **增量备份**：每小时进行一次增量备份
3. **备份验证**：定期验证备份文件的可用性
4. **备份存储**：备份文件存储在安全的位置，最好异地存储

### 7.2 恢复策略

1. **恢复演练**：定期进行恢复演练，确保备份可用
2. **恢复流程**：制定详细的恢复流程文档
3. **恢复时间目标**：明确RTO（Recovery Time Objective）和RPO（Recovery Point Objective）

## 8. 附录

### 8.1 相关SQL语句

#### 8.1.1 表创建语句

```sql
-- 创建用户表
CREATE TABLE `user` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(255) NOT NULL COMMENT '密码（加密存储）',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `nickname` VARCHAR(50) DEFAULT NULL COMMENT '昵称',
  `gender` TINYINT DEFAULT 0 COMMENT '性别（0:未知, 1:男, 2:女）',
  `birthday` DATE DEFAULT NULL COMMENT '生日',
  `status` TINYINT DEFAULT 1 COMMENT '状态（0:禁用, 1:启用）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_phone` (`phone`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建商品分类表
CREATE TABLE `category` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `name` VARCHAR(50) NOT NULL COMMENT '分类名称',
  `parent_id` BIGINT DEFAULT 0 COMMENT '父分类ID（0表示顶级分类）',
  `level` TINYINT DEFAULT 1 COMMENT '分类级别（1:一级, 2:二级, 3:三级）',
  `sort` INT DEFAULT 0 COMMENT '排序序号',
  `icon` VARCHAR(255) DEFAULT NULL COMMENT '分类图标URL',
  `status` TINYINT DEFAULT 1 COMMENT '状态（0:禁用, 1:启用）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_sort` (`sort`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建商品表
CREATE TABLE `product` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '商品ID',
  `name` VARCHAR(100) NOT NULL COMMENT '商品名称',
  `category_id` BIGINT NOT NULL COMMENT '分类ID',
  `price` DECIMAL(10,2) NOT NULL COMMENT '价格',
  `original_price` DECIMAL(10,2) DEFAULT NULL COMMENT '原价',
  `stock` INT NOT NULL COMMENT '库存',
  `sales` INT DEFAULT 0 COMMENT '销量',
  `description` LONGTEXT COMMENT '商品描述',
  `detail` LONGTEXT COMMENT '商品详情',
  `main_image` VARCHAR(255) DEFAULT NULL COMMENT '主图URL',
  `images` TEXT COMMENT '轮播图URL（JSON数组格式）',
  `status` TINYINT DEFAULT 1 COMMENT '状态（0:下架, 1:上架）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_name` (`name`),
  KEY `idx_price` (`price`),
  KEY `idx_sales` (`sales`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_product_category` FOREIGN KEY (`category_id`) REFERENCES `category` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建购物车表
CREATE TABLE `cart` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '购物车ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `product_id` BIGINT NOT NULL COMMENT '商品ID',
  `quantity` INT NOT NULL COMMENT '数量',
  `selected` TINYINT DEFAULT 1 COMMENT '是否选中（0:未选中, 1:选中）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_product` (`user_id`,`product_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_product_id` (`product_id`),
  CONSTRAINT `fk_cart_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  CONSTRAINT `fk_cart_product` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建订单表
CREATE TABLE `orders` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `order_no` VARCHAR(50) NOT NULL COMMENT '订单号',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `total_amount` DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
  `actual_pay` DECIMAL(10,2) NOT NULL COMMENT '实际支付金额',
  `status` TINYINT DEFAULT 0 COMMENT '订单状态（0:待支付, 1:待发货, 2:待收货, 3:待评价, 4:已完成, 5:已取消, 6:已退款）',
  `payment_type` TINYINT DEFAULT NULL COMMENT '支付方式（1:微信, 2:支付宝）',
  `payment_no` VARCHAR(100) DEFAULT NULL COMMENT '支付流水号',
  `consignee` VARCHAR(50) NOT NULL COMMENT '收货人姓名',
  `phone` VARCHAR(20) NOT NULL COMMENT '收货人电话',
  `province` VARCHAR(50) NOT NULL COMMENT '省份',
  `city` VARCHAR(50) NOT NULL COMMENT '城市',
  `district` VARCHAR(50) NOT NULL COMMENT '区县',
  `detail_address` VARCHAR(255) NOT NULL COMMENT '详细地址',
  `remark` VARCHAR(255) DEFAULT NULL COMMENT '订单备注',
  `payment_time` DATETIME DEFAULT NULL COMMENT '支付时间',
  `delivery_time` DATETIME DEFAULT NULL COMMENT '发货时间',
  `receive_time` DATETIME DEFAULT NULL COMMENT '收货时间',
  `cancel_time` DATETIME DEFAULT NULL COMMENT '取消时间',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_payment_time` (`payment_time`),
  CONSTRAINT `fk_order_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建订单项表
CREATE TABLE `order_item` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '订单项ID',
  `order_id` BIGINT NOT NULL COMMENT '订单ID',
  `product_id` BIGINT NOT NULL COMMENT '商品ID',
  `product_name` VARCHAR(100) NOT NULL COMMENT '商品名称',
  `product_image` VARCHAR(255) DEFAULT NULL COMMENT '商品图片',
  `unit_price` DECIMAL(10,2) NOT NULL COMMENT '商品单价',
  `quantity` INT NOT NULL COMMENT '购买数量',
  `total_price` DECIMAL(10,2) NOT NULL COMMENT '小计金额',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_product_id` (`product_id`),
  CONSTRAINT `fk_order_item_order` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`),
  CONSTRAINT `fk_order_item_product` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建管理员表
CREATE TABLE `admin` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '管理员ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(255) NOT NULL COMMENT '密码（加密存储）',
  `name` VARCHAR(50) DEFAULT NULL COMMENT '姓名',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '电话',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `role_id` BIGINT DEFAULT NULL COMMENT '角色ID',
  `status` TINYINT DEFAULT 1 COMMENT '状态（0:禁用, 1:启用）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建商品评价表
CREATE TABLE `review` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '评价ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `product_id` BIGINT NOT NULL COMMENT '商品ID',
  `order_item_id` BIGINT NOT NULL COMMENT '订单项ID',
  `rating` TINYINT NOT NULL COMMENT '评分（1-5星）',
  `content` TEXT COMMENT '评价内容',
  `images` TEXT COMMENT '评价图片（JSON数组格式）',
  `likes` INT DEFAULT 0 COMMENT '点赞数',
  `status` TINYINT DEFAULT 1 COMMENT '状态（0:待审核, 1:已审核, 2:已禁用）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_order_item_id` (`order_item_id`),
  KEY `idx_rating` (`rating`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_review_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  CONSTRAINT `fk_review_product` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`),
  CONSTRAINT `fk_review_order_item` FOREIGN KEY (`order_item_id`) REFERENCES `order_item` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建收货地址表
CREATE TABLE `address` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '地址ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `consignee` VARCHAR(50) NOT NULL COMMENT '收货人姓名',
  `phone` VARCHAR(20) NOT NULL COMMENT '收货人电话',
  `province` VARCHAR(50) NOT NULL COMMENT '省份',
  `city` VARCHAR(50) NOT NULL COMMENT '城市',
  `district` VARCHAR(50) NOT NULL COMMENT '区县',
  `detail_address` VARCHAR(255) NOT NULL COMMENT '详细地址',
  `is_default` TINYINT DEFAULT 0 COMMENT '是否默认地址（0:否, 1:是）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_user_default` (`user_id`,`is_default`),
  CONSTRAINT `fk_address_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 8.2 索引使用示例

```sql
-- 查询用户的所有订单
SELECT * FROM orders WHERE user_id = 1 ORDER BY create_time DESC;

-- 查询特定状态的订单
SELECT * FROM orders WHERE status = 1 ORDER BY create_time DESC LIMIT 10;

-- 查询商品的评价
SELECT * FROM review WHERE product_id = 1 AND status = 1 ORDER BY create_time DESC;

-- 查询用户的购物车
SELECT * FROM cart WHERE user_id = 1 AND selected = 1;

-- 搜索商品
SELECT * FROM product WHERE name LIKE '%手机%' AND status = 1 ORDER BY sales DESC;
```

### 8.3 数据备份语句

```sql
-- 全量备份
mysqldump -u root -p shopping > shopping_backup_$(date +%Y%m%d).sql

-- 单表备份
mysqldump -u root -p shopping user > shopping_user_backup_$(date +%Y%m%d).sql
```

### 8.4 数据恢复语句

```sql
-- 恢复数据库
mysql -u root -p shopping < shopping_backup_20240101.sql

-- 恢复单表
mysql -u root -p shopping < shopping_user_backup_20240101.sql
```